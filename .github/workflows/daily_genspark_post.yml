name: Daily Genspark Instagram Post

# 【重要】このワークフローは以下の正しいフローを必ず実行する:
# 1. NotebookLMから文体・事業情報を取得
# 2. 最新ニュースをリアルタイム検索
# 3. ブログ記事を生成（必須！スキップ禁止！）
# 4. ブログからInstagram投稿用コンテンツを作成
# 5. 画像生成（Genspark NanoBananaPro）
# 6. FTPにアップロード
# 7. Publerでスケジュール
#
# 【投稿スケジュール】毎日1回投稿:
# - 18:00 JST (UTC 09:00) → ローテーション (ai → business → education)

on:
  # 手動実行
  workflow_dispatch:
    inputs:
      category:
        description: '投稿カテゴリ'
        required: true
        default: 'ai'
        type: choice
        options:
          - ai
          - business
          - education
          - development
          - activity
          - announcement

  # スケジュール実行（毎日1回）
  schedule:
    # 18:00 JST = UTC 09:00 → ローテーション
    - cron: '0 9 * * *'

env:
  NODE_VERSION: '20'
  TZ: 'Asia/Tokyo'

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install browser dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgbm-dev \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon-x11-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libcups2 \
            libasound2t64 \
            fonts-noto-cjk \
            fonts-noto-cjk-extra \
            xvfb

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Restore Genspark authentication state
        env:
          GENSPARK_STATE: ${{ secrets.GENSPARK_STATE }}
        run: |
          mkdir -p data
          if [ -n "$GENSPARK_STATE" ]; then
            # Base64 decode and gzip decompress
            echo "$GENSPARK_STATE" | base64 -d | gunzip > data/genspark_state.json
            echo "Genspark state restored from secret (gzip compressed)"
          else
            echo "Warning: GENSPARK_STATE secret not set"
          fi

      # NotebookLMはGitHub Actions上では利用不可（ローカル実行時のみ）
      # フォールバック情報が自動的に使用される

      - name: Determine category by rotation
        id: category
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "value=${{ github.event.inputs.category }}" >> $GITHUB_OUTPUT
            echo "post_time=manual" >> $GITHUB_OUTPUT
          else
            # スケジュール実行時は日にちベースでローテーション
            # 日にちを3で割った余りでカテゴリを決定
            # 0 = ai, 1 = business, 2 = education
            DAY_OF_MONTH=$(date +%d)
            REMAINDER=$((DAY_OF_MONTH % 3))
            echo "Day of month: $DAY_OF_MONTH, Remainder: $REMAINDER"

            case $REMAINDER in
              0)
                echo "value=ai" >> $GITHUB_OUTPUT
                ;;
              1)
                echo "value=business" >> $GITHUB_OUTPUT
                ;;
              2)
                echo "value=education" >> $GITHUB_OUTPUT
                ;;
            esac
            echo "post_time=18:00" >> $GITHUB_OUTPUT
          fi

          echo "=== カテゴリ決定 ==="
          echo "カテゴリ: $(cat $GITHUB_OUTPUT | grep value | cut -d'=' -f2)"
          echo "投稿時間: $(cat $GITHUB_OUTPUT | grep post_time | cut -d'=' -f2)"

      - name: Generate and Post
        env:
          # API Keys
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GENSPARK_EMAIL: ${{ secrets.GENSPARK_EMAIL }}
          GENSPARK_PASSWORD: ${{ secrets.GENSPARK_PASSWORD }}
          # FTP
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_PATH: ${{ secrets.FTP_REMOTE_PATH }}
          FTP_BASE_URL: ${{ secrets.FTP_BASE_URL }}
          # Publer
          PUBLER_API_KEY: ${{ secrets.PUBLER_API_KEY }}
          PUBLER_WORKSPACE_ID: ${{ secrets.PUBLER_WORKSPACE_ID }}
          PUBLER_ACCOUNT_ID: ${{ secrets.PUBLER_ACCOUNT_ID }}
          # NotebookLMはGitHub Actions上では利用不可（フォールバック使用）
          # ローカル実行時は自動的に検出される
        run: |
          echo "=========================================="
          echo "=== 正しいワークフローを実行 ==="
          echo "=========================================="
          echo ""
          echo "投稿スケジュール: ${{ steps.category.outputs.post_time }} JST"
          echo "カテゴリ: ${{ steps.category.outputs.value }}"
          echo ""
          echo "【重要】以下のステップを必ず実行:"
          echo "ステップ0: NotebookLMから文体・事業情報を取得（GitHub Actionsではフォールバック使用）"
          echo "ステップ1: 最新ニュースをリアルタイム検索【最新情報を取得】"
          echo "ステップ2: ブログ記事を生成【必須・スキップ禁止】"
          echo "ステップ3: ブログからInstagram要約を生成"
          echo "ステップ4-8: 画像生成（品質チェック5回） → FTP → Publer"
          echo ""
          echo "【投稿スケジュール】毎日18:00 JST"
          echo "カテゴリは日にちに基づくローテーション:"
          echo "- 余り0の日 → AI (ai)"
          echo "- 余り1の日 → ビジネス (business)"
          echo "- 余り2の日 → 教育 (education)"
          echo ""
          # xvfbで仮想ディスプレイを使用（ヘッドレス検出を回避）
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
            npm run generate:genspark -- --category=${{ steps.category.outputs.value }}

      - name: Upload generated assets
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-content-${{ steps.category.outputs.value }}-${{ github.run_number }}
          path: |
            assets/generated/
            data/blogs/
          retention-days: 7

      - name: Commit post history and blogs
        if: success() && github.event_name == 'schedule'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 投稿履歴とブログファイルが変更されていればコミット
          git add data/*.json assets/generated/blogs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update post history and blog (${{ steps.category.outputs.value }}) - $(date '+%Y-%m-%d %H:%M')"
            git push
          fi

      - name: Summary
        if: success()
        run: |
          echo "## Instagram投稿生成完了" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**投稿時間**: ${{ steps.category.outputs.post_time }} JST" >> $GITHUB_STEP_SUMMARY
          echo "**カテゴリ**: ${{ steps.category.outputs.value }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 投稿スケジュール" >> $GITHUB_STEP_SUMMARY
          echo "毎日18:00 JST（ローテーション）" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 日にち÷3の余り | カテゴリ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| 0 | AI (ai) |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | ビジネス (business) |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | 教育 (education) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 実行されたステップ" >> $GITHUB_STEP_SUMMARY
          echo "1. NotebookLMから文体・事業情報を取得" >> $GITHUB_STEP_SUMMARY
          echo "2. 最新ニュースをリアルタイム検索" >> $GITHUB_STEP_SUMMARY
          echo "3. ブログ記事を生成" >> $GITHUB_STEP_SUMMARY
          echo "4. Instagram要約を作成" >> $GITHUB_STEP_SUMMARY
          echo "5. 画像生成（Genspark NanoBananaPro）+ 品質チェック" >> $GITHUB_STEP_SUMMARY
          echo "6. FTPにアップロード" >> $GITHUB_STEP_SUMMARY
          echo "7. Publerでスケジュール" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::ワークフローが失敗しました。ログを確認してください。"
          echo "## エラー発生" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ワークフローが失敗しました。詳細はログを確認してください。" >> $GITHUB_STEP_SUMMARY
